buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        // Android Gradle Plugin + Kotlin plugin
        classpath 'com.android.tools.build:gradle:8.2.2'
        classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.22'
    }
}

apply plugin: "com.android.library"
apply plugin: "org.jetbrains.kotlin.android"

android {
    namespace "com.appfig.sdk"
    compileSdk 34

    defaultConfig {
        minSdk 21
        targetSdk 34

        consumerProguardFiles "consumer-rules.pro"
    }

    buildTypes {
        release {
            minifyEnabled false
            shrinkResources false
        }
    }

    packagingOptions {
        pickFirst "**/*.jar"
        pickFirst "**/*.kotlin_metadata"
        pickFirst "**/*.kotlin_module"
    }

    kotlinOptions {
        jvmTarget = "17"
    }
}

repositories {
    google()
    mavenCentral()
}

//
// -------- FAT AAR CONFIG --------
// Everything added to `embed` is merged into the AAR
//
configurations {
    embed
    implementation.extendsFrom(embed)
}

dependencies {
    // Dependencies to embed inside the AAR
    embed "com.squareup.okhttp3:okhttp:4.12.0"
    embed "com.google.code.gson:gson:2.10.1"

    // Kotlin runtime
    implementation "org.jetbrains.kotlin:kotlin-stdlib:1.9.22"
}

//
// -------- MERGE EMBEDDED JARS INTO THE AAR --------
// This produces a REAL fat AAR with OkHttp + Gson bundled.
//
afterEvaluate {
    tasks.withType(com.android.build.gradle.tasks.BundleAar).configureEach { task ->
        task.doLast {
            def outDir = task.archiveFile.get().asFile.parentFile
            def aarFile = task.archiveFile.get().asFile

            // Unpack AAR to temp dir
            def tempDir = new File(outDir, "tempAar")
            if (tempDir.exists()) tempDir.deleteDir()
            tempDir.mkdirs()

            copy {
                from zipTree(aarFile)
                into tempDir
            }

            // Add embedded dependencies under /libs
            def libsDir = new File(tempDir, "libs")
            libsDir.mkdirs()

            configurations.embed.each { file ->
                if (!file.isDirectory()) {
                    copy {
                        from file
                        into libsDir
                    }
                }
            }

            // Repack AAR
            aarFile.delete()
            ant.zip(destfile: aarFile, basedir: tempDir)

            tempDir.deleteDir()
        }
    }
}
