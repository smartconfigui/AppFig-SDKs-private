plugins {
    id "com.android.library"
    id "org.jetbrains.kotlin.android"
}

android {
    namespace "com.appfig.sdk"
    compileSdk 34

    defaultConfig {
        minSdk 21
        targetSdk 34

        consumerProguardFiles "consumer-rules.pro"
    }

    buildTypes {
        release {
            minifyEnabled false
            shrinkResources false
        }
    }

    packagingOptions {
        pickFirst "**/*.jar"
        pickFirst "**/*.kotlin_metadata"
        pickFirst "**/*.kotlin_module"
    }

    // Kotlin JVM target
    kotlinOptions {
        jvmTarget = "17"
    }
}

repositories {
    google()
    mavenCentral()
}

//
// --- FAT AAR CONFIG ------------------------------------------------------
// Everything added to `embed` will be physically packed INSIDE the AAR
//
configurations {
    embed
    implementation.extendsFrom(embed)
}

dependencies {
    // Dependencies to embed inside AAR
    embed "com.squareup.okhttp3:okhttp:4.12.0"
    embed "com.google.code.gson:gson:2.10.1"

    // Kotlin standard library
    implementation "org.jetbrains.kotlin:kotlin-stdlib:1.9.22"
}

//
// --- MERGE EMBEDDED DEPENDENCIES INTO THE AAR -----------------------------
// Ensures OkHttp & Gson jars are included physically in the final AAR
//
afterEvaluate {
    tasks.withType(com.android.build.gradle.tasks.BundleAar).configureEach { task ->
        task.doLast {
            def outDir = task.archiveFile.get().asFile.parentFile
            def aarFile = task.archiveFile.get().asFile

            // Unzip AAR into temp directory
            def tempDir = new File(outDir, "tempAar")
            if (tempDir.exists()) tempDir.deleteDir()
            tempDir.mkdirs()

            copy {
                from zipTree(aarFile)
                into tempDir
            }

            // Copy embedded jars into /libs inside AAR
            def libsDir = new File(tempDir, "libs")
            libsDir.mkdirs()

            configurations.embed.each { file ->
                if (!file.isDirectory()) {
                    copy {
                        from file
                        into libsDir
                    }
                }
            }

            // Repack AAR with embedded libs
            aarFile.delete()
            ant.zip(destfile: aarFile, basedir: tempDir)
            tempDir.deleteDir()
        }
    }
}
