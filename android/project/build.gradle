plugins {
    id "com.android.library"
    id "org.jetbrains.kotlin.android"
}

android {
    namespace "com.appfig.sdk"
    compileSdk 34

    defaultConfig {
        minSdk 21
        targetSdk 34

        consumerProguardFiles "consumer-rules.pro"
    }

    buildTypes {
        release {
            minifyEnabled false
            shrinkResources false
        }
    }

    packagingOptions {
        pickFirst "**/*.jar"
        pickFirst "**/*.kotlin_metadata"
        pickFirst "**/*.kotlin_module"
    }

    kotlinOptions {
        jvmTarget = "17"
    }
}

repositories {
    google()
    mavenCentral()
}

configurations {
    embed
    implementation.extendsFrom(embed)
}

dependencies {
    embed "com.squareup.okhttp3:okhttp:4.12.0"
    embed "com.google.code.gson:gson:2.10.1"

    implementation "org.jetbrains.kotlin:kotlin-stdlib:1.9.22"
}

afterEvaluate {
    tasks.withType(com.android.build.gradle.tasks.BundleAar).configureEach { task ->
        task.doLast {
            def outDir = task.archiveFile.get().asFile.parentFile
            def aarFile = task.archiveFile.get().asFile

            def tempDir = new File(outDir, "tempAar")
            if (tempDir.exists()) tempDir.deleteDir()
            tempDir.mkdirs()

            copy {
                from zipTree(aarFile)
                into tempDir
            }

            def libsDir = new File(tempDir, "libs")
            libsDir.mkdirs()

            configurations.embed.each { file ->
                if (!file.isDirectory()) {
                    copy {
                        from file
                        into li
