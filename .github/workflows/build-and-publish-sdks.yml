name: Build and publish AppFig SDKs

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "unity/**"
      - "react/**"
      - "ios/**"
      - "android/**"
      - "VERSION"
      - ".github/workflows/build-and-publish-sdks.yml"

env:
  PUBLIC_REPO: AppFig/AppFig-SDKs
  PUBLIC_REPO_BRANCH: main

jobs:
  build-and-publish:
    runs-on: macos-latest

    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4

      - name: Read version
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      #######################################################
      # REACT BUILD (TS → minified JS)
      #######################################################

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build React SDK
        run: |
          set -e
          rm -rf artifacts/react
          rm -rf ci-react-build
          mkdir -p artifacts/react
          mkdir -p ci-react-build

          cd ci-react-build
          npm init -y
          npm install esbuild typescript

          npx esbuild ../react/AppFigReactSDK.ts \
            --bundle \
            --minify \
            --platform=neutral \
            --format=esm \
            --outfile=../artifacts/react/AppFigReactSDK.min.js

          echo "declare const AppFig: any;" > ../artifacts/react/index.d.ts
          echo "export default AppFig;" >> ../artifacts/react/index.d.ts

      #######################################################
      # UNITY SDK — COPY DLL YOU PROVIDE
      #######################################################

      - name: Prepare Unity DLL artifact
        run: |
          set -e
          rm -rf artifacts/unity
          mkdir -p artifacts/unity

          DLL="unity/AppFig.dll"
          if [ ! -f "$DLL" ]; then
            echo "ERROR: unity/AppFig.dll not found. Upload a compiled DLL to unity/ first."
            exit 1
          fi

          cp "$DLL" artifacts/unity/AppFig.dll

      #######################################################
      # ANDROID BUILD (Kotlin → AAR)
      #######################################################

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build Android AAR
        run: |
          set -e
          rm -rf artifacts/android
          mkdir -p artifacts/android

          cd android/project
          ./gradlew assembleRelease

          AAR="build/outputs/aar/project-release.aar"
          if [ ! -f "$AAR" ]; then
            echo "Android AAR not found"; exit 1;
          fi

          cp "$AAR" ../../artifacts/android/appfig-release.aar

      #######################################################
      # iOS BUILD (SwiftPM → XCFramework)
      #######################################################

      - name: Build iOS XCFramework
        run: |
          set -e
          rm -rf artifacts/ios
          mkdir -p artifacts/ios

          cd ios/project
          swift build -c release

          PRODUCT=".build/apple/Products/Release/AppFig.framework"
          if [ ! -d "$PRODUCT" ]; then
            echo "Swift build failed"; exit 1;
          fi

          xcodebuild -create-xcframework \
            -framework "$PRODUCT" \
            -output AppFig.xcframework

          cp -R AppFig.xcframework ../../artifacts/ios/

      #######################################################
      # PUBLISH ARTIFACTS TO PUBLIC REPO
      #######################################################

      - name: Clone public repo
        run: |
          set -e
          git clone \
            https://x-access-token:${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/${{ env.PUBLIC_REPO }}.git \
            public-repo

      - name: Replace public repo contents
        run: |
          set -e
          cd public-repo

          find . -mindepth 1 -maxdepth 1 ! -name ".git" -exec rm -rf {} +

          mkdir -p unity react ios android

          cp -R ../artifacts/unity/* unity/
          cp -R ../artifacts/react/* react/
          cp -R ../artifacts/ios/* ios/
          cp -R ../artifacts/android/* android/

          echo "${{ steps.version.outputs.version }}" > VERSION

          echo "AppFig SDKs" > README.md
          echo "" >> README.md
          echo "Auto-generated from AppFig-SDKs-private." >> README.md
          echo "Contains packaged SDK artifacts for Unity, React, iOS, and Android." >> README.md
          echo "Do not edit manually." >> README.md

      - name: Commit and push artifacts
        run: |
          set -e
          cd public-repo

          git config user.name "AppFig SDK Bot"
          git config user.email "sdk-bot@appfig.com"

          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Publish SDK artifacts v${{ steps.version.outputs.version }}"
            git push origin ${{ env.PUBLIC_REPO_BRANCH }}
          fi

      - name: Tag public repo
        run: |
          set -e
          cd public-repo
          VERSION="${{ steps.version.outputs.version }}"

          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            git tag -d "v$VERSION"
          fi

          git tag "v$VERSION"
          git push origin "v$VERSION" --force
