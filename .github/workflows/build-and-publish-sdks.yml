name: Build and Publish AppFig SDKs

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  PUBLIC_REPO: AppFig/AppFig-SDKs
  PUBLIC_BRANCH: main

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4

      - name: Prepare artifacts
        run: |
          rm -rf artifacts
          mkdir -p artifacts/android artifacts/ios artifacts/unity artifacts/react

      ###########################################################
      # 1. ANDROID AAR BUILD
      ###########################################################
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build Android AAR
        run: |
          set -e
          cd android/project
          chmod +x ./gradlew
          ./gradlew clean assembleRelease
          AAR=$(find build -name "*.aar" | head -n 1)
          if [ -z "$AAR" ]; then
            echo "ERROR: No AAR found."
            find build -type f
            exit 1
          fi
          cp "$AAR" ../../artifacts/android/AppFigAndroidSDK.aar

      ###########################################################
      # 2. iOS XCFRAMEWORK BUILD
      ###########################################################
      - name: Build iOS (Device)
        run: |
          set -e
          cd ios/AppFig
          xcodebuild \
            -project AppFig.xcodeproj \
            -scheme AppFig \
            -sdk iphoneos \
            -configuration Release \
            -archivePath build/ios_devices.xcarchive \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
            archive

      - name: Build iOS (Simulator)
        run: |
          set -e
          cd ios/AppFig
          xcodebuild \
            -project AppFig.xcodeproj \
            -scheme AppFig \
            -sdk iphonesimulator \
            -configuration Release \
            -archivePath build/ios_simulator.xcarchive \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
            archive

      - name: Create iOS XCFramework
        run: |
          set -e
          cd ios/AppFig
          xcodebuild -create-xcframework \
            -framework build/ios_devices.xcarchive/Products/Library/Frameworks/AppFig.framework \
            -framework build/ios_simulator.xcarchive/Products/Library/Frameworks/AppFig.framework \
            -output AppFig.xcframework
          cp -R AppFig.xcframework ../../artifacts/ios/

      # ZIP the XCFramework (NEW)
      - name: Zip iOS XCFramework
        run: |
          set -e
          cd ios/AppFig
          zip -r AppFig.xcframework.zip AppFig.xcframework
          cp AppFig.xcframework.zip ../../artifacts/ios/

      ###########################################################
      # 3. UNITY — COPY ALL FILES BEGINNING WITH AppFig*
      ###########################################################
      - name: Copy Unity SDK files
        run: |
          set -e
          echo "Copying all Unity files starting with AppFig* ..."
          mkdir -p artifacts/unity
          
          FOUND=$(ls unity/AppFig* 2>/dev/null | wc -l | tr -d ' ')
          if [ "$FOUND" = "0" ]; then
            echo "ERROR: No files starting with AppFig* found under /unity"
            ls -R unity
            exit 1
          fi

          cp -v unity/AppFig* artifacts/unity/

          echo "Unity artifacts:"
          ls -lh artifacts/unity

      ###########################################################
      # 4. REACT SDK — Option B (AppFigReactSDK.js + .d.ts)
      ###########################################################
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build React SDK
        run: |
          set -e
          rm -rf react-build
          mkdir react-build

          cd react-build
          npm init -y
          npm install esbuild typescript

          # Output JS with final name
          npx esbuild ../react/AppFigReactSDK.ts \
            --bundle \
            --minify \
            --platform=neutral \
            --format=esm \
            --outfile=../artifacts/react/AppFigReactSDK.js

          # Same-name type definition
          echo "declare const AppFig: any;" > ../artifacts/react/AppFigReactSDK.d.ts
          echo "export default AppFig;" >> ../artifacts/react/AppFigReactSDK.d.ts

      ###########################################################
      # 5. CLONE PUBLIC REPO
      ###########################################################
      - name: Clone public repo
        run: |
          git clone https://x-access-token:${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/${{ env.PUBLIC_REPO }}.git public-repo

      ###########################################################
      # 6. PUBLISH ARTIFACTS
      ###########################################################
      - name: Publish artifacts to public repo
        run: |
          set -e
          cd public-repo
          find . -mindepth 1 -maxdepth 1 ! -name ".git" -exec rm -rf {} +
          mkdir -p android ios unity react

          cp -R ../artifacts/android/* android/
          cp -R ../artifacts/ios/* ios/
          cp -R ../artifacts/unity/* unity/
          cp -R ../artifacts/react/* react/

          cat > README.md << 'EOF'
          # AppFig SDKs

          Pre-built AppFig SDKs for **iOS**, **Android**, **Unity**, and **React Web**.  
          Download the SDK for your platform from the folders above and drop it directly into your project.

          ## What is AppFig?

          AppFig is a **client-side feature engine** for apps and games — instant feature flags, audience targeting, and real-time rule evaluation with zero latency.

          ## Documentation

          Full guides for each platform are available at:

          https://appfig.com/docs

          ## Support & Feedback

          Questions or suggestions?  
          Email us anytime: **hello@appfig.com**
          EOF

      - name: Commit & Push
        run: |
          set -e
          cd public-repo
          git config user.name "AppFig SDK Bot"
          git config user.email "sdk-bot@appfig.com"
          git add .
          if git diff --cached --quiet; then
            echo "No changes to publish."
          else
            git commit -m "Publish latest AppFig SDK artifacts"
            git push origin ${{ env.PUBLIC_BRANCH }}
          fi
