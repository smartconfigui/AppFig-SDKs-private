name: Build & Publish SDKs

on:
  push:
    branches:
      - main

jobs:
  build-and-publish:
    runs-on: macos-latest

    steps:
      - name: Checkout private repository
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Swift toolchain
        run: |
          swift --version

      - name: Prepare artifacts folder
        run: |
          mkdir -p artifacts/android
          mkdir -p artifacts/ios
          mkdir -p artifacts/react
          mkdir -p artifacts/unity

      #######################################################
      # ANDROID BUILD (.aar)
      #######################################################
      - name: Build Android AAR
        run: |
          set -e
          cd android/project

          # Apply toolchain fix & namespace fix dynamically
          sed -i '' 's/compileSdkVersion 33/compileSdkVersion 34/' build.gradle
          sed -i '' 's/targetSdkVersion 33/targetSdkVersion 34/' build.gradle

          # Remove AndroidManifest package warning
          sed -i '' 's/package="com.appfig.sdk"//' src/main/AndroidManifest.xml

          # Force JVM toolchain to 17
          cat >> build.gradle <<EOF

android {
    namespace "com.appfig.sdk"
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
    kotlinOptions {
        jvmTarget = "17"
    }
}
EOF

          ./gradlew clean assembleRelease --warning-mode all

          AAR_PATH=$(find build/outputs/aar -name "*.aar" | head -n 1)
          if [ -z "$AAR_PATH" ]; then
            echo "Android AAR not found"
            exit 1
          fi

          cp "$AAR_PATH" ../../artifacts/android/AppFigAndroidSDK.aar


      #######################################################
      # iOS BUILD (SwiftPM â†’ XCFramework)
      #######################################################
      - name: Prepare SwiftPM Project
        run: |
          set -e
          rm -rf ios/build
          mkdir -p ios/build/Sources/AppFig

          # Move all SDK Swift files into SwiftPM folder
          cp ios/*.swift ios/build/Sources/AppFig/

          # Create Package.swift
          cat > ios/build/Package.swift << 'EOF'
          // swift-tools-version:5.7
          import PackageDescription

          let package = Package(
              name: "AppFig",
              platforms: [.iOS(.v13)],
              products: [
                  .library(name: "AppFig", targets: ["AppFig"])
              ],
              targets: [
                  .target(name: "AppFig", path: "Sources/AppFig")
              ]
          )
          EOF

      - name: Build iOS XCFramework
        run: |
          set -e
          rm -rf artifacts/ios/*
          cd ios/build

          swift build -c release

          FRAMEWORK_PATH=$(find .build -type d -name "AppFig.framework" | head -n 1)
          if [ -z "$FRAMEWORK_PATH" ]; then
            echo "AppFig.framework not found"
            find .build -type d -maxdepth 5
            exit 1
          fi

          xcodebuild -create-xcframework \
            -framework "$FRAMEWORK_PATH" \
            -output AppFig.xcframework

          cp -R AppFig.xcframework ../../artifacts/ios/


      #######################################################
      # REACT SDK BUILD
      #######################################################
      - name: Build React SDK
        run: |
          set -e
          cd react

          rm -rf dist
          npm install
          npm run build

          cp -R dist ../artifacts/react/


      #######################################################
      # UNITY SDK (DLL COPY)
      #######################################################
      - name: Copy Unity DLL
        run: |
          set -e
          cp unity/*.dll artifacts/unity/


      #######################################################
      # PUBLISH TO PUBLIC SDK REPO
      #######################################################
      - name: Checkout public repo
        uses: actions/checkout@v3
        with:
          repository: smartconfigui/AppFig-SDKs-public
          token: ${{ secrets.GH_PAT }}
          path: public

      - name: Sync Artifacts to Public Repo
        run: |
          set -e
          rm -rf public/android public/ios public/react public/unity

          mkdir -p public/android public/ios public/react public/unity

          cp artifacts/android/* public/android/
          cp -R artifacts/ios/* public/ios/
          cp -R artifacts/react/* public/react/
          cp artifacts/unity/* public/unity/

      - name: Commit & Push
        run: |
          cd public
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git add .
          git commit -m "SDK Build $(date)" || echo "No changes"
          git push
